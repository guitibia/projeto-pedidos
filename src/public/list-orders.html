<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lista de Pedidos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="/css/styles.css">
</head>

<body>
  <!-- Navbar (Menu superior) -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">INÍCIO</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Alternar navegação">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="/create-client.html">Cadastrar Cliente</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/create-product.html">Cadastrar Produto</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/create-order.html">Criar Pedido</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="/list-orders.html">Listar Pedidos</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <h2 class="text-center mb-4">Lista de Pedidos</h2>
    <table class="table table-striped table-hover">
      <thead>
        <tr>
          <th>ID</th>
          <th>Cliente</th>
          <th>Método de Pagamento</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="ordersList">
        <!-- A lista de pedidos será preenchida aqui -->
      </tbody>
    </table>
  </div>

  <!-- Modal para exibir os detalhes do pedido -->
  <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="orderDetailsModalLabel">Detalhes do Pedido</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body" id="orderDetailsContent">
          <!-- Os detalhes do pedido serão preenchidos aqui -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button type="button" class="btn btn-success" id="markAsDeliveredButton">Marcar como Entregue</button>
          <button type="button" class="btn btn-outline-primary" id="printButton">Imprimir Pedido</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Rodapé -->
  <footer class="bg-dark text-white text-center py-3 mt-5">
    <p>&copy; 2024 Sistema de Cadastro. Todos os direitos reservados.</p>
  </footer>

  <script>
    // Função para carregar pedidos
    function loadOrders() {
      fetch('/api/orders')
        .then(response => response.json())
        .then(orders => {
          const ordersList = document.getElementById('ordersList');
          ordersList.innerHTML = ''; // Limpar lista antes de adicionar os novos itens

          orders.forEach(order => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${order.id}</td>
              <td>${order.client_name || 'Cliente Desconhecido'}</td>  
              <td>${order.payment_method}</td>
              <td>${order.status || 'Pendente'}</td>
              <td>
                <button class="btn btn-info btn-sm btn-custom" onclick="viewOrder(${order.id})">
                  <i class="bi bi-eye"></i> Ver
                </button>
                <button class="btn btn-danger btn-sm btn-custom" onclick="deleteOrder(${order.id})">
                  <i class="bi bi-trash"></i> Excluir
                </button>
              </td>
            `;
            ordersList.appendChild(tr);
          });
        })
        .catch(error => {
          console.error('Erro ao carregar pedidos:', error);
          Swal.fire('Erro', 'Não foi possível carregar os pedidos. Tente novamente.', 'error');
        });
    }

    // Função para visualizar o pedido
    function viewOrder(orderId) {
      fetch(`/api/orders/${orderId}`)
        .then(response => response.json())
        .then(data => {
          const order = data;
          const orderDetailsContent = document.getElementById('orderDetailsContent');

          // Verificar se 'products' é um array e tem produtos
          const productsList = Array.isArray(order.products) && order.products.length > 0
            ? order.products.map(product => {
              return `
              <li>
                <strong>Produto:</strong> ${product.product_name}<br>
                <strong>Valor de Venda:</strong> R$ ${product.sale_price.toFixed(2)}<br>
                <strong>Valor de Custo:</strong> R$ ${product.cost_price.toFixed(2)}
              </li>
            `;
            }).join('')
            : '<li><strong>Sem produtos associados a este pedido.</strong></li>'; // Caso não haja produtos

          // Calcular o total do valor de venda do pedido
          const totalSaleValue = Array.isArray(order.products) && order.products.length > 0
            ? order.products.reduce((total, product) => total + (product.sale_price || 0), 0).toFixed(2)
            : '0.00';

          // Condicional para ocultar o parcelamento nos métodos de pagamento "PIX", "Dinheiro" e "Cartão de Crédito"
          const isInstallmentVisible = !(order.payment_method === 'PIX' || order.payment_method === 'Dinheiro' || order.payment_method === 'Cartão de Crédito');
          const installmentInfo = isInstallmentVisible && order.installments
            ? `<p><strong>Parcelado em:</strong> ${order.installments} vezes</p>`
            : '';

          // Exibir as informações detalhadas do pedido
          orderDetailsContent.innerHTML = `  
        <h4>ID do Pedido: ${order.id}</h4>
        <p><strong>Cliente:</strong> ${order.client_name}</p>
        <p><strong>Método de Pagamento:</strong> ${order.payment_method}</p>
        <p><strong>Status:</strong> ${order.status || 'Pendente'}</p>
        ${installmentInfo}
        <h5>Produtos:</h5>
        <ul>
          ${productsList}
        </ul>
        <h5>Total Valor de Venda:</h5>
        <p>R$ ${totalSaleValue}</p>
      `;

          const orderDetailsModal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
          orderDetailsModal.show();

          // Configurar o botão de impressão
          document.getElementById('printButton').onclick = () => {
            printOrderDetails(order);
          };

          // Marcar como Entregue
          document.getElementById('markAsDeliveredButton').onclick = () => {
            markOrderAsDelivered(order.id);
          };
        })
        .catch(error => {
          console.error('Erro ao carregar detalhes do pedido:', error);
          Swal.fire('Erro', 'Erro ao carregar detalhes do pedido', 'error');
        });
    }

    // Função para imprimir os detalhes do pedido
    function printOrderDetails(order) {
      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write('<html><head><title>Pedido - ' + order.id + '</title></head><body>');
      printWindow.document.write('<h3>Detalhes do Pedido ' + order.id + '</h3>');
      printWindow.document.write('<p><strong>Cliente:</strong> ' + order.client_name + '</p>');
      printWindow.document.write('<p><strong>Método de Pagamento:</strong> ' + order.payment_method + '</p>');
      printWindow.document.write('<p><strong>Status:</strong> ' + (order.status || 'Pendente') + '</p>');

      // Exibir o parcelamento se necessário (somente para métodos que não sejam PIX, Dinheiro e Cartão de Crédito)
      if (order.payment_method !== 'PIX' && order.payment_method !== 'Dinheiro' && order.payment_method !== 'Cartão de Crédito' && order.installments) {
        printWindow.document.write('<h5>Parcelado em:</h5>');
        printWindow.document.write('<p>' + order.installments + ' vezes</p>');
      }

      printWindow.document.write('<h5>Produtos:</h5><ul>');
      if (Array.isArray(order.products) && order.products.length > 0) {
        order.products.forEach(product => {
          printWindow.document.write(`
        <li>
          <strong>Produto:</strong> ${product.product_name}<br>
          <strong>Valor de Venda:</strong> R$ ${product.sale_price.toFixed(2)}<br>
          <strong>Valor de Custo:</strong> R$ ${product.cost_price.toFixed(2)}
        </li>
      `);
        });
      } else {
        printWindow.document.write('<li><strong>Sem produtos associados a este pedido.</strong></li>');
      }
      printWindow.document.write('</ul>');
      printWindow.document.write('<h5>Total Valor de Venda:</h5>');
      printWindow.document.write('<p>R$ ' + (Array.isArray(order.products) && order.products.length > 0 ? order.products.reduce((total, product) => total + (product.sale_price || 0), 0).toFixed(2) : '0.00') + '</p>');
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.print();
    }



    // Função para marcar o pedido como entregue
    function markOrderAsDelivered(orderId) {
      fetch(`/api/orders/${orderId}/status`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: 'Entregue' })
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Erro ao atualizar o status do pedido');
          }
          return response.json();
        })
        .then(data => {
          Swal.fire('Sucesso', 'Pedido marcado como entregue!', 'success');
          loadOrders();
        })
        .catch(error => {
          console.error('Erro ao atualizar status do pedido:', error);
          Swal.fire('Erro', 'Erro ao marcar o pedido como entregue', 'error');
        });
    }

    // Função para imprimir os detalhes do pedido
    function printOrderDetails(order) {
      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write('<html><head><title>Pedido - ' + order.id + '</title></head><body>');
      printWindow.document.write('<h3>Detalhes do Pedido ' + order.id + '</h3>');
      printWindow.document.write('<p><strong>Cliente:</strong> ' + order.client_name + '</p>');
      printWindow.document.write('<p><strong>Método de Pagamento:</strong> ' + order.payment_method + '</p>');
      printWindow.document.write('<p><strong>Status:</strong> ' + (order.status || 'Pendente') + '</p>');
      printWindow.document.write('<h5>Produtos:</h5><ul>');
      order.products.forEach(product => {
        printWindow.document.write('<li>' + product.product_name + '</li>');
      });
      printWindow.document.write('</ul>');
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.print();
    }

    // Função para excluir o pedido
    function deleteOrder(orderId) {
      Swal.fire({
        title: 'Você tem certeza?',
        text: "Este pedido será excluído permanentemente!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sim, excluir!',
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/api/orders/${orderId}`, {
            method: 'DELETE',
          })
            .then(response => response.json())
            .then(data => {
              Swal.fire('Sucesso', 'Pedido excluído com sucesso!', 'success');
              loadOrders();
            })
            .catch(error => {
              console.error('Erro ao excluir pedido:', error);
              Swal.fire('Erro', 'Erro ao excluir o pedido', 'error');
            });
        }
      });
    }

    // Carregar os pedidos quando a página for carregada
    window.onload = loadOrders;
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.js"></script>
</body>

</html>